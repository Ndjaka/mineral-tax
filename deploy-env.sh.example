#!/bin/bash
# Script pour d√©ployer le fichier .env sur le serveur Infomaniak
# 
# IMPORTANT : Copiez ce fichier vers deploy-env.sh et configurez votre mot de passe
# cp deploy-env.sh.example deploy-env.sh
# nano deploy-env.sh  # Ajouter votre mot de passe

# Configuration
REMOTE_HOST="57-106659.ssh.hosting-ik.com"
REMOTE_USER="N89UEvW6WcN_Mineraltax"
REMOTE_PATH="sites/mineraltax.ch"

# ‚ö†Ô∏è CONFIGURER VOTRE MOT DE PASSE ICI (ou utiliser une variable d'environnement)
# Option 1 : D√©finir directement (NON RECOMMAND√â si vous commitez ce fichier)
# export SSHPASS='votre_mot_de_passe'

# Option 2 : Utiliser une variable d'environnement (RECOMMAND√â)
# Ajoutez dans votre ~/.zshrc ou ~/.bashrc :
# export INFOMANIAK_SSH_PASSWORD='votre_mot_de_passe'
if [ -z "$SSHPASS" ]; then
    if [ -n "$INFOMANIAK_SSH_PASSWORD" ]; then
        export SSHPASS="$INFOMANIAK_SSH_PASSWORD"
    else
        echo "‚ùå Erreur : Mot de passe SSH non configur√©"
        echo ""
        echo "Configurez le mot de passe de l'une des fa√ßons suivantes :"
        echo ""
        echo "Option 1 : Variable d'environnement dans ce script"
        echo "  √âditez deploy-env.sh et d√©finissez :"
        echo "  export SSHPASS='votre_mot_de_passe'"
        echo ""
        echo "Option 2 : Variable d'environnement globale (recommand√©)"
        echo "  Ajoutez dans ~/.zshrc :"
        echo "  export INFOMANIAK_SSH_PASSWORD='votre_mot_de_passe'"
        echo "  Puis : source ~/.zshrc"
        echo ""
        echo "Option 3 : Passer le mot de passe en ligne de commande"
        echo "  SSHPASS='votre_mot_de_passe' ./deploy-env.sh"
        exit 1
    fi
fi

echo "üîê Transfert du fichier .env vers le serveur..."

# V√©rifier que le fichier .env existe
if [ ! -f ".env" ]; then
    echo "‚ùå Erreur : fichier .env introuvable"
    exit 1
fi

# Transf√©rer le .env
sshpass -e rsync -avz \
  -e "ssh -o StrictHostKeyChecking=no" \
  .env \
  ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/.env

if [ $? -eq 0 ]; then
    echo "‚úÖ Fichier .env transf√©r√© avec succ√®s"
    echo ""
    echo "üîÑ Red√©marrage de l'application pour charger les nouvelles variables..."
    
    # Red√©marrer l'application pour charger les nouvelles variables
    sshpass -e ssh -o StrictHostKeyChecking=no \
      ${REMOTE_USER}@${REMOTE_HOST} \
      "cd ${REMOTE_PATH} && ./node_modules/.bin/pm2 restart mineraltax" || true
    
    echo "‚úÖ Application red√©marr√©e"
else
    echo "‚ùå Erreur lors du transfert"
    exit 1
fi
